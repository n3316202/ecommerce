{% extends 'layout/base.html' %}
{% load static %}

{% block content %}

  {% comment %} #dev_47 head 수정 {% endcomment %}
  {% include 'payment/head.html' %}
  <script>
    function requestPay() {
      //const amount = document.getElementById("price").value;
      const amount = 10;

      const IMP = window.IMP; 
      IMP.init("imp43216235"); // 예: imp00000000a
      IMP.request_pay(
        {
          pg: "html5_inicis", //PG사
          pay_method: "card", //결제방식
          //merchant_uid: "ORD20180131-0000011", // 주문번호, 상품ID, 생략시 자동생성
          name: "노르웨이 회전 의자",
          amount: amount, // 결제금액
          buyer_email: "gildong@gmail.com",	//구매자 이메일
          buyer_name: "홍길동",	//구매자 이름
          buyer_tel: "010-4242-4242",	//구매자 전화번호
          buyer_addr: "서울특별시 강남구 신사동",	//구매자 주소
          buyer_postcode: "01181",	//구매자 번호
        },
        function (rsp) {
          console.log(rsp);      
          if (rsp.success) {
            //Backend API에 결제완료 처리
            //axios.post(
            //  "http://localhost:3000/payment",
            //  {
            //    impUid: rsp.imp_uid,
            //    amount: rsp.paid_amount,
            //  },
            //  {
            //    /*
            //    headers: {
            //      Authorization: "Bearer " + token,
            //    },
            //    */
            //  }
            //);
            
            alert("결제 성공");
          } else {
            alert("결제 실패");
          }
        }
      );
    }
  </script>


  <!-- 네비게이션바 -->
  {% include "layout/navbar.html" %}

  <header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
      <div class="text-center text-white">
        <h1 class="display-4 fw-bolder">장바구니</h1>
        <p class="lead fw-normal text-white-50 mb-0">View your Cart</p>
      </div>
    </div>
  </header>

  <br/>

  <div class="container">
    {% if cart_products%}
      {% for product in cart_products %}
        <form action="{% url 'payment:payment_process_order'%}" method="post">
          {% csrf_token %}
          <div class="card mb-3">
            <div class="row g-0">
              <div class="col-md-4">
                <img src=" {{product.image.url}}" style="width:100%;height:18rem;object-fit:fill" class="img-fluid rounded-start" alt="..."/>
              </div>
              <div class="col-md-8">
                <div class="card-body mt-4">
                  <center>
                    <h5 class="card-title">{{product.name}}</h5>
                    <p class="card-text">{{product.description}}</p>

                    {% if product.is_sale%}

                      <div class="d-flex justify-content-center small text-warning mb-2">
                        <div class="bi-star-fill"></div>
                        <div class="bi-star-fill"></div>
                        <div class="bi-star-fill"></div>
                        <div class="bi-star-fill"></div>
                        <div class="bi-star-fill"></div>
                      </div>
                      <!-- Product price-->
                      <strike>
                        ${{ product.price }}
                      </strike>
                      &nbsp; ${{product.sale_price}}
                    {% else %}
                      ${{ product.price }}
                      <br/>
                      ID :
                      {{product.id}}
                      {%endif%}
                      <br/><br/>
                      <div class="row justify-content-center">
                        <div class="col-md-2">Quantity</div>
                        <div class="col-md-2">
                          <select class="form-select form-select-sm" id="select{{product.id}}" aria-label="Default select example">
                            {% for key, value in quantities.items %}
                              {% if key == product.id|slugify%}
                                <option selected="selected">{{ value }}</option>
                              {% endif %}
                            {% endfor %}
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                          </select>
                        </div>
                      </div>
                      <br/>
                      <a href="{% url 'store:home' %}" class="btn btn-secondary">홈으로</a>
                      {% comment %} <button type="button" value="{{product.id}}" id="add-cart" class="btn btn-secondary">Add to Cart</button> {% endcomment %}
                      <button type="button" data-index="{{product.id}}" class="btn btn-secondary update-cart">업데이트</button>
                      <button type="button" data-index="{{product.id}}" class="btn btn-danger delete-product">삭제</button>
                    </center>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
          {% comment %} #dev_43 {% endcomment %}
        </form>
        {% comment %} #dev_47 임시로 {% endcomment %}
        <div class="text-center">
          <h3 >Total:{{totals}}원</h3>
          {% comment %} <a class="btn btn-success text-center" href="{% url 'payment:payment_process_order'%}">주문</a> {% endcomment %}
          <button onclick="requestPay()" type="submit" class="btn btn-success text-center" >주문</button>
        </div>

        <br />
        <br />
        <br />
      {% else %}
        There's Nothing in your cart
      {% endif %}
    </div>

    <script>
      $(document).on('click', '.update-cart', function (e) {
        let productid = $(this).data('index');
        let qty = $('#select' + productid + ' ' + 'option:selected').text();

        $.ajax({
          type: 'POST',
          url: '{% url "cart:cart_update" %}',
          data: {
            product_id: $(this).data('index'),
            product_qty: qty,
            csrfmiddlewaretoken: '{{  csrf_token }}',
            action: 'post'
          },
          success: function (json) {
            console.log(json);
            location.reload();
          },
          error: function (e) {
            console.log(e);
          }
        });
      });

      $(document).on('click', '.delete-product', function (e) {
        let productid = $(this).data('index');
    
        $.ajax({
          type: 'POST',
          url: '{% url "cart:cart_delete" %}',
          data: {
            product_id: $(this).data('index'),
    
            csrfmiddlewaretoken: '{{  csrf_token }}',
            action: 'post',
          },
          success: function (json) {
            console.log(json);
            location.reload(); //페이지 새로 고침
          },
          error: function (e) {
            console.log(e);
          },
        });
      });
    </script>
  {%endblock content%}
